<div class="container mt-5">
  <div class="card border-1">
    <div class="card-body">
      <form #enrolementForm="ngForm" (ngSubmit)="onSubmit(enrolementForm)" novalidate>
        <div class="row g-3">

          <!-- Student Dropdown -->
          <div class="col-md-12">
            <div class="floating">
              <select name="studentId" class="form-select" [(ngModel)]="enrolement.detailsDto.studentId"
                #studentId="ngModel" (focus)="isStudentFocused = true" (blur)="isStudentFocused = false"
                [ngClass]="{ 'active': enrolement.detailsDto.studentId || isStudentFocused }" required>
                <option *ngFor="let s of enrolement.users" [value]="s.id">
                  {{ s.name }}
                </option>
              </select>
              <label>Student *</label>
            </div>
            <div class="text-danger small" *ngIf="studentId.invalid && studentId.touched">
              Student is required
            </div>
          </div>

          <!-- Enrollment Date -->
          <div class="col-md-12">
            <div class="floating">
              <input type="date" name="enrolledDate" class="form-control"
                [(ngModel)]="enrolement.detailsDto.enrolledDate" #enrolledDate="ngModel" (focus)="isDateFocused = true"
                (blur)="isDateFocused = false"
                [ngClass]="{ 'active': enrolement.detailsDto.enrolledDate || isDateFocused }" required
                (change)="onEnrollmentDateChange(enrolement.detailsDto.enrolledDate)" />
              <label>Enrollment Date *</label>
            </div>
            <div class="text-danger small" *ngIf="enrolledDate.invalid && enrolledDate.touched">
              Enrollment date is required
            </div>
          </div>

          <!-- Is TA -->
          <div class="col-md-12">
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" name="isTa" [(ngModel)]="enrolement.detailsDto.isTa"
                id="isTa" />
              <label class="form-check-label" for="isTa">
                Teaching Assistant
              </label>
            </div>
          </div>

          <!-- TA Lab Days & Slots -->
          <div *ngIf="enrolement.detailsDto.isTa" class="mt-4 ta-lab-hours-section">

            <h5 class="mb-3">TA Lab Hours</h5>

            <div *ngFor="let day of taLabDays; let dIndex = index" class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="d-flex align-items-center gap-2">
                  <input type="date" class="form-control form-control-sm" [(ngModel)]="day.labDate" />
                  <span class="small text-muted">{{ getDayNameFromDate(day.labDate) }}</span>
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm" (click)="removeLabDay(dIndex)">
                  Remove Day
                </button>
              </div>

              <div class="border rounded p-3 mb-3" *ngFor="let slot of day.slots; let sIndex = index">
                <div class="row g-2 align-items-end">

                  <div class="col-md-3">
                    <label>Start Time</label>
                    <input type="time" class="form-control" [(ngModel)]="slot.startTime"
                      name="start{{day.id}}{{sIndex}}" required />
                  </div>

                  <div class="col-md-3">
                    <label>End Time</label>
                    <input type="time" class="form-control" [(ngModel)]="slot.endTime" name="end{{day.id}}{{sIndex}}"
                      required />
                  </div>

                  <div class="col-md-3">
                    <label>Mode</label>
                    <select class="form-select" [(ngModel)]="slot.mode" name="mode{{day.id}}{{sIndex}}" required>
                      <option [ngValue]="LabMode.InPerson">In Person</option>
                      <option [ngValue]="LabMode.Remote">Remote</option>
                      <option [ngValue]="LabMode.Hybrid">Hybrid</option>
                    </select>
                  </div>

                  <div class="col-md-2" *ngIf="slot.mode === LabMode.Remote || slot.mode === LabMode.Hybrid">
                    <label>Remote Link</label>
                    <input type="text" class="form-control" [(ngModel)]="slot.remoteLink"
                      name="link{{day.id}}{{sIndex}}" />
                  </div>

                  <div class="col-md-1 text-end">
                    <button type="button" class="btn btn-outline-danger btn-sm" (click)="removeLabSlot(day, sIndex)">Ã—
                    </button>
                  </div>

                </div>
              </div>

              <button type="button" class="btn btn-outline-primary mb-3" (click)="addLabSlot(day)">
                Add Slot
              </button>
            </div>

            <div class="fw-semibold" [class.text-danger]="getTotalWeeklyHours() > maxWeeklyHours">
              Total Hours: {{ getTotalWeeklyHours() | number:'1.1-1' }} / {{ maxWeeklyHours }}
            </div>
            <div class="text-danger mt-2" *ngIf="getTotalWeeklyHours() > maxWeeklyHours">
              Total TA lab hours cannot exceed {{ maxWeeklyHours }} hours.
            </div>

            <button type="button" class="btn btn-outline-success mb-3" (click)="addLabDay()">
              Add New Lab Day
            </button>

          </div>

        </div>

        <div class="mt-4 d-flex justify-content-end">
          <button type="button" class="btn btn-secondary me-2" (click)="onCancel()">
            Cancel
          </button>

          <button type="submit" class="btn btn-primary">
            {{
            enrolement.detailsDto.id !== EMPTY_ID
            ? 'Update Enrollment'
            : 'Create Enrollment'
            }}
          </button>
        </div>

      </form>
    </div>
  </div>
</div>